from sys import argv
import yaml


# Configuration file for the Sphinx documentation builder.
#
# This file only contains a selection of the most common options. For a full
# list see the documentation:
# https://www.sphinx-doc.org/en/master/usage/configuration.html

# -- Path setup --------------------------------------------------------------

# If extensions (or modules to document with autodoc) are in another directory,
# add these directories to sys.path here. If the directory is relative to the
# documentation root, use os.path.abspath to make it absolute, like shown here.
#
# import os
# import sys
# sys.path.insert(0, os.path.abspath('.'))


# -- Project information -----------------------------------------------------

project = '@CMAKE_PROJECT_NAME@'
copyright = '@COPYRIGHT_YEAR@, Jordi Moya-Laraño'
author = 'Jordi Moya-Laraño, Mario Carmona Segovia, José Román Bilbao-Castro'

# Se obtiene el valor de la variable de esta forma porque con el parámetro -D
# se le cambia el valor a la variable tras ejecutarse el archivo conf.py
version = 'latest'
for i, arg in enumerate(argv):
    if arg == '-D' and i + 1 < len(argv):
        if argv[i + 1].startswith('version='):
            version = argv[i + 1].split('=')[1]


# -- General configuration ---------------------------------------------------

# Add any paths that contain templates here, relative to this directory.
templates_path = ['_templates']

# List of patterns, relative to source directory, that match files and
# directories to ignore when looking for source files.
# This pattern also affects html_static_path and html_extra_path.
exclude_patterns = []


# -- Localization configuration -------------------

main_language = '@MAIN_LANGUAGE@'

language = 'en'
for i, arg in enumerate(argv):
    if arg == '-D' and i + 1 < len(argv):
        if argv[i + 1].startswith('language='):
            language = argv[i + 1].split('=')[1]

# Directories in which to search for additional message catalogs, relative 
# to the source directory
locale_dirs = ['@SPHINX_LOCALE_DIRECTORY@/']

# If true, a document’s text domain is its docname if it is a top-level 
# project file and its very base directory otherwise.
# 
# If set to string, all document’s text domain is this string, making all 
# documents use single text domain.
# 
# By default, the document markup/code.rst ends up in the markup text 
# domain. With this option set to False, it is markup/code.
gettext_compact = False


# -- Options for HTML output -------------------------------------------------

# If given, this must be the name of an image file (path relative to the configuration 
# directory) that is the logo of the docs, or URL that points an image file for the logo. 
# It is placed at the top of the sidebar; its width should therefore not 
# exceed 200 pixels. Default: None.
html_logo = '_static/img/logo.png'

# The theme to use for HTML and HTML Help pages.  See the documentation for
# a list of builtin themes.
#
html_theme = 'sphinx_rtd_theme'

html_theme_options = {
    #############################
    # Table of contents options #
    #############################

    # With this enabled, navigation entries are not expandable – the [+] icons 
    # next to each entry are removed.
    "collapse_navigation": "false",

    # Scroll the navigation with the main page content as you scroll the page.
    "sticky_navigation": "true",

    # The maximum depth of the table of contents tree. Set this to -1 to allow unlimited depth.
    "navigation_depth": -1,

    # Specifies if the navigation includes hidden table(s) of contents – that is, 
    # any toctree directive that is marked with the :hidden: option.
    "includehidden": "false",

    # When enabled, page subheadings are not included in the navigation.
    "titles_only": "false",

    #########################
    # Miscellaneous options #
    #########################

    # If specified, Google Analytics’ gtag.js is included in your pages. Set the value to the 
    # ID provided to you by google (like UA-XXXXXXX or G-XXXXXXXXXX).
    "analytics_id": "",

    # Anonymize visitor IP addresses in Google Analytics.
    "analytics_anonymize_ip": "false",

    # If True, the version number is shown at the top of the sidebar.
    "display_version": "true",

    # Only display the logo image, do not display the project name at the top of the sidebar
    "logo_only": "true",

    # Location to display Next and Previous buttons. This can be either bottom, top, both , or None.
    "prev_next_buttons_location": "top",

    # Add an icon next to external links.
    "style_external_links": "false",

    # Changes how to view files when using display_github, display_gitlab, etc. When using GitHub 
    # or GitLab this can be: blob (default), edit, or raw. On Bitbucket, this can be 
    # either: view (default) or edit.
    "vcs_pageview_mode": "view",

    # Changes the background of the search area in the navigation bar. The value can be anything 
    # valid in a CSS background property.
    "style_nav_header_background": "#2980B9"
}

# Add any paths that contain custom static files (such as style sheets) here,
# relative to this directory. They are copied after the builtin static files,
# so a file named "default.css" will overwrite the builtin "default.css".
html_static_path = ['_static']

html_baseurl = ''
for i, arg in enumerate(argv):
    if arg == '-D' and i + 1 < len(argv):
        if argv[i + 1].startswith('html_baseurl='):
            html_baseurl = argv[i + 1].split('=')[1]

html_context = {
    'current_version' : version,
    'versions' : [],
    'current_language' : language,
    'languages' : []
}

with open("versions.yaml", "r") as yaml_file:
    versions_info = yaml.safe_load(yaml_file)

for current_version, details in versions_info.items():
    html_context['versions'].append([current_version, html_baseurl+'/'+current_version])
    if(version == current_version):
        for current_language in details.get('languages', []): 
            if(main_language == current_language):
                html_context['languages'].append([current_language, html_baseurl+'/'+current_version])
            else:
                html_context['languages'].append([current_language, html_baseurl+'/'+current_version+'/'+current_language])


# -- Extensions configuration ----------------------------------------------

# Add any Sphinx extension module names here, as strings. They can be
# extensions coming with Sphinx (named 'sphinx.ext.*') or your custom
# ones.
extensions = [
    'breathe'
]


# -- Breathe configuration -------------------

breathe_projects = {
  "@CMAKE_PROJECT_NAME@": "doxygen/xml"
}

breathe_default_project = '@CMAKE_PROJECT_NAME@'
